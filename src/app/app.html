<div class="flex flex-col h-screen w-full bg-white relative">
      
      <!-- 1. Top Global Bar (Gray/Action) -->
      <div class="bg-gray-800 text-gray-200 flex items-center justify-between px-4 py-2 text-sm shadow-sm z-20">
         <!-- Left: Branding -->
         <div class="flex items-center space-x-3">
            <div class="flex items-center text-green-400 font-bold text-lg tracking-tight">
              <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
              JSON Editor <span class="text-white opacity-60 ml-1 font-light">Online</span>
            </div>
         </div>

         <!-- Right: Global Actions -->
         <div class="flex items-center space-x-4">
            <button (click)="resetNew()" class="flex items-center hover:text-white transition group relative">
               <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
               New
               <span class="absolute top-full left-1/2 -translate-x-1/2 mt-1 bg-black text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap">Clear Editor</span>
            </button>
            <div class="relative group">
              <button class="flex items-center hover:text-white transition">
                 <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"/></svg>
                 Open
                 <svg class="w-3 h-3 ml-1 opacity-50" fill="currentColor" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
              </button>
              <!-- Dropdown for Open -->
              <div class="absolute right-0 mt-2 w-48 bg-white text-gray-800 rounded shadow-lg border border-gray-200 hidden group-hover:block z-50">
                <label class="flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer">
                  <input type="file" class="hidden" (change)="onFileSelected($event)" accept=".json,.txt">
                  <span>Open from Disk</span>
                </label>
                <button (click)="openUrlModal()" class="w-full text-left px-4 py-2 hover:bg-gray-100">Open from URL</button>
              </div>
            </div>
            
            <button (click)="saveFile()" class="flex items-center hover:text-white transition group relative">
               <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
               Save
               <span class="absolute top-full left-1/2 -translate-x-1/2 mt-1 bg-black text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap">Download .json</span>
            </button>
            <button (click)="copyToClipboard()" class="flex items-center hover:text-white transition group relative">
               <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
               Copy
               <span class="absolute top-full left-1/2 -translate-x-1/2 mt-1 bg-black text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap">Copy to Clipboard</span>
            </button>
             <button (click)="toggleFullscreen()" class="flex items-center hover:text-white transition" title="Full Screen">
               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
            </button>
         </div>
      </div>

      <!-- 2. Main Workspace Toolbar (Green) -->
      <div class="bg-[#74a558] text-white flex items-center justify-between px-2 py-1.5 shadow-md z-10 select-none">
        
        <!-- Left: View Mode Toggles -->
        <div class="flex items-center border border-white/30 rounded overflow-hidden">
          <button (click)="viewMode.set('code')" [class.bg-white_25]="viewMode() === 'code'" class="px-3 py-1 hover:bg-white/10 text-xs font-semibold uppercase tracking-wide transition">Code</button>
          <div class="w-px bg-white/30 h-4"></div>
          <button (click)="viewMode.set('tree')" [class.bg-white_25]="viewMode() === 'tree'" class="px-3 py-1 hover:bg-white/10 text-xs font-semibold uppercase tracking-wide transition">Tree</button>
          <div class="w-px bg-white/30 h-4"></div>
           <button (click)="viewMode.set('split')" [class.bg-white_25]="viewMode() === 'split'" class="px-3 py-1 hover:bg-white/10 text-xs font-semibold uppercase tracking-wide transition">Both</button>
        </div>

        <div class="h-6 w-px bg-white/30 mx-3"></div>

        <!-- Center: Editor Actions -->
        <div class="flex items-center space-x-1">
          <button (click)="state.formatContent()" title="Format (Indent)" class="p-1.5 hover:bg-white/20 rounded transition">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
          </button>
          <button (click)="state.minifyContent()" title="Compact" class="p-1.5 hover:bg-white/20 rounded transition">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
          </button>
          <button (click)="state.sortContent()" title="Sort" class="p-1.5 hover:bg-white/20 rounded transition">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" /></svg>
          </button>
          
          <div class="h-6 w-px bg-white/30 mx-2"></div>

          <!-- Tree Actions -->
          <button (click)="onExpandAll()" title="Expand All" class="p-1.5 hover:bg-white/20 rounded transition">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 13l-7 7-7-7m14-8l-7 7-7-7" /></svg>
          </button>
          <button (click)="onCollapseAll()" title="Collapse All" class="p-1.5 hover:bg-white/20 rounded transition">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 11l7-7 7 7M5 19l7-7 7 7" /></svg>
          </button>

          <div class="h-6 w-px bg-white/30 mx-2"></div>
          
          <!-- History -->
           <button (click)="state.undo()" [disabled]="!state.canUndo" title="Undo" class="p-1.5 hover:bg-white/20 rounded transition disabled:opacity-40">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>
          </button>
           <button (click)="state.redo()" [disabled]="!state.canRedo" title="Redo" class="p-1.5 hover:bg-white/20 rounded transition disabled:opacity-40">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6" /></svg>
          </button>
        </div>

        <div class="flex-1"></div>

        <!-- Right: AI & Search -->
        <div class="flex items-center space-x-3">
           <!-- AI Menu -->
           <div class="flex items-center space-x-1 mr-4">
              <button (click)="openGenerateModal()" class="text-xs bg-white/10 hover:bg-white/20 px-2 py-1 rounded flex items-center">
                 <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                 Generate
              </button>
              @if(!state.isValid()) {
                <button (click)="fixJson()" class="text-xs bg-red-600 hover:bg-red-700 px-2 py-1 rounded flex items-center animate-pulse">
                   Fix
                </button>
              }
           </div>

           <!-- Search Bar (Now simplified as Ace handles search mostly, but we can keep for future filter) -->
           <div class="text-xs text-white/70 italic mr-2 hidden sm:block">
              Use Ctrl+F in editor to search
           </div>
        </div>
      </div>

      <!-- 3. Main Workspace Split -->
      <main class="flex-1 flex overflow-hidden relative">
        
        <!-- Code Pane (Raw/Free) -->
        @if (viewMode() === 'code' || viewMode() === 'split') {
          <section class="flex flex-col min-w-0 border-r border-gray-300" [class.flex-1]="true" [style.width.%]="viewMode() === 'split' ? 50 : 100">
            <app-code-editor [formattedMode]="false"></app-code-editor>
          </section>
        }

        <!-- Tree Pane (Formatted/Safe) -->
        @if (viewMode() === 'tree' || viewMode() === 'split') {
          <section class="flex flex-col min-w-0 bg-white" [class.flex-1]="true" [style.width.%]="viewMode() === 'split' ? 50 : 100">
             <!-- Using Ace Editor as the 'Tree View' (Formatted) -->
             <app-code-editor [formattedMode]="true"></app-code-editor>
          </section>
        }

        <!-- Loading Overlay -->
        @if (isLoading()) {
          <div class="absolute inset-0 bg-black/10 z-50 flex items-center justify-center backdrop-blur-[2px]">
            <div class="bg-white px-6 py-4 rounded-lg shadow-xl flex items-center space-x-3">
              <div class="animate-spin rounded-full h-5 w-5 border-2 border-green-600 border-t-transparent"></div>
              <span class="text-gray-700 font-medium">Processing...</span>
            </div>
          </div>
        }

        <!-- Notification Toast -->
        @if (notification()) {
          <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-md shadow-lg text-sm font-medium z-50 animate-bounce transition-all">
             {{ notification() }}
          </div>
        }
      </main>

      <!-- 4. Footer Status Bar -->
      <footer class="bg-gray-100 border-t border-gray-300 px-4 py-1 flex justify-between items-center text-xs text-gray-500 font-mono select-none">
        <div class="flex items-center space-x-4">
           <span [class.text-green-600]="state.isValid()" [class.text-red-600]="!state.isValid()">
             {{ state.isValid() ? '✔ Valid' : '✖ Invalid Format' }}
           </span>
           <span>{{ state.stats().items }} items</span>
           <span>{{ state.stats().size }}</span>
        </div>
        <div>
           Pro JSON Editor AI v1.0
        </div>
      </footer>
      
      <!-- Modals -->
      @if (showGenerateModal()) {
        <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
          <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Generate JSON with Gemini</h3>
            <textarea [(ngModel)]="generatePrompt" class="w-full border border-gray-300 rounded p-3 text-sm min-h-[100px] mb-4 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Describe the JSON you want..."></textarea>
            <div class="flex justify-end space-x-2">
              <button (click)="closeGenerateModal()" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
              <button (click)="confirmGenerate()" [disabled]="!generatePrompt.trim()" class="px-4 py-2 text-sm bg-green-600 hover:bg-green-700 text-white rounded disabled:opacity-50">Generate</button>
            </div>
          </div>
        </div>
      }
    </div>